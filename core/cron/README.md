# Cronè°ƒåº¦æœåŠ¡

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºRedisæŒä¹…åŒ–çš„å®Œæ•´cronè°ƒåº¦æœåŠ¡ï¼Œæ”¯æŒç³»ç»Ÿä»»åŠ¡å’Œè‡ªå®šä¹‰HTTPä»»åŠ¡çš„è°ƒåº¦æ‰§è¡Œã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ•’ **æ ‡å‡†Cronè¡¨è¾¾å¼æ”¯æŒ** - æ”¯æŒç§’çº§ç²¾åº¦çš„cronè¡¨è¾¾å¼
- ğŸ”„ **ä»»åŠ¡æŒä¹…åŒ–** - åŸºäºRedisçš„ä»»åŠ¡æ•°æ®æŒä¹…åŒ–å­˜å‚¨
- ğŸ“Š **æ‰§è¡Œå†å²** - å®Œæ•´çš„ä»»åŠ¡æ‰§è¡Œå†å²è®°å½•å’Œç»Ÿè®¡
- ğŸ”§ **ç³»ç»Ÿä»»åŠ¡** - å†…ç½®ç³»ç»Ÿä»»åŠ¡å¤„ç†å™¨ï¼Œæ”¯æŒæ‰©å±•
- ğŸŒ **HTTPä»»åŠ¡** - æ”¯æŒè‡ªå®šä¹‰HTTPè¯·æ±‚ä»»åŠ¡
- âš¡ **é«˜æ€§èƒ½** - åŸºäºgoroutineçš„å¹¶å‘æ‰§è¡Œ
- ğŸ›¡ï¸ **å®¹é”™æœºåˆ¶** - æ”¯æŒé‡è¯•ã€è¶…æ—¶æ§åˆ¶
- ğŸ“ˆ **ç›‘æ§ç»Ÿè®¡** - æä¾›è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡å’ŒçŠ¶æ€ç›‘æ§

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Serviceå±‚     â”‚    â”‚   Schedulerå±‚   â”‚    â”‚  Repositoryå±‚   â”‚
â”‚  ä¸šåŠ¡é€»è¾‘æ¥å£   â”‚â”€â”€â”€â–¶â”‚   ä»»åŠ¡è°ƒåº¦å™¨    â”‚â”€â”€â”€â–¶â”‚   æ•°æ®æŒä¹…åŒ–    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚                       â”‚
          â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Taskå®ç°      â”‚    â”‚   Cronå¼•æ“      â”‚    â”‚   Rediså­˜å‚¨     â”‚
â”‚ HTTP/Systemä»»åŠ¡ â”‚    â”‚ robfig/cron/v3  â”‚    â”‚  ä»»åŠ¡+å†å²æ•°æ®  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä»»åŠ¡ç±»å‹

### 1. HTTPä»»åŠ¡

æ”¯æŒæ‰€æœ‰æ ‡å‡†HTTPæ–¹æ³•çš„è‡ªå®šä¹‰ä»»åŠ¡ï¼š

```json
{
    "name": "APIå¥åº·æ£€æŸ¥",
    "description": "å®šæœŸæ£€æŸ¥APIæœåŠ¡çŠ¶æ€",
    "cron": "0 */5 * * * *",
    "type": "http",
    "config": {
        "url": "https://api.example.com/health",
        "method": "GET",
        "headers": {
            "Authorization": "Bearer your-token",
            "Content-Type": "application/json"
        },
        "body": "",
        "timeout": 30000000000,
        "retry_count": 3,
        "retry_delay": 5000000000,
        "expected_code": 200
    }
}
```

**HTTPä»»åŠ¡ç‰¹æ€§ï¼š**
- æ”¯æŒGETã€POSTã€PUTã€DELETEç­‰æ‰€æœ‰HTTPæ–¹æ³•
- è‡ªåŠ¨Content-Typeæ£€æµ‹ï¼ˆJSON/è¡¨å•ï¼‰
- çµæ´»çš„è¯·æ±‚å¤´é…ç½®
- æœŸæœ›çŠ¶æ€ç éªŒè¯
- é‡è¯•æœºåˆ¶å’Œè¶…æ—¶æ§åˆ¶

### 2. ç³»ç»Ÿä»»åŠ¡

å†…ç½®ç³»ç»Ÿä»»åŠ¡å¤„ç†å™¨ï¼Œæ”¯æŒæ‰©å±•ï¼š

#### æ—¥å¿—å¤„ç†å™¨ (`log`)
```json
{
    "handler_name": "log",
    "parameters": {
        "level": "info",
        "message": "ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ"
    }
}
```

#### ç¼“å­˜æ¸…ç†å¤„ç†å™¨ (`cache_clean`)
```json
{
    "handler_name": "cache_clean",
    "parameters": {
        "pattern": "temp:*"
    }
}
```

#### æ•°æ®åº“ç»´æŠ¤å¤„ç†å™¨ (`db_maintenance`)
```json
{
    "handler_name": "db_maintenance",
    "parameters": {
        "action": "analyze"
    }
}
```

## Cronè¡¨è¾¾å¼æ ¼å¼

æ”¯æŒ6ä½æˆ–7ä½cronè¡¨è¾¾å¼ï¼ˆåŒ…å«ç§’ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç§’ (0-59)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ† (0-59)
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¶ (0-23)
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€ æ—¥ (1-31)
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€ æœˆ (1-12)
â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€ å‘¨ (0-6, å‘¨æ—¥=0)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
* * * * * *
```

**å¸¸ç”¨ç¤ºä¾‹ï¼š**
- `0 */5 * * * *` - æ¯5åˆ†é’Ÿæ‰§è¡Œ
- `0 0 2 * * *` - æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
- `0 0 9 * * 1-5` - å·¥ä½œæ—¥ä¸Šåˆ9ç‚¹æ‰§è¡Œ
- `0 30 8 1 * *` - æ¯æœˆ1æ—¥ä¸Šåˆ8ç‚¹30åˆ†æ‰§è¡Œ

## ä»»åŠ¡çŠ¶æ€

- `active` - æ¿€æ´»çŠ¶æ€ï¼Œæ­£åœ¨è°ƒåº¦æ‰§è¡Œ
- `paused` - æš‚åœçŠ¶æ€ï¼Œæš‚æ—¶åœæ­¢è°ƒåº¦
- `stopped` - åœæ­¢çŠ¶æ€ï¼Œæ°¸ä¹…åœæ­¢

## æ‰§è¡ŒçŠ¶æ€

- `running` - æ‰§è¡Œä¸­
- `success` - æ‰§è¡ŒæˆåŠŸ
- `failed` - æ‰§è¡Œå¤±è´¥
- `timeout` - æ‰§è¡Œè¶…æ—¶

## Rediså­˜å‚¨ç»“æ„

```
cron:task:{task_id}        # ä»»åŠ¡è¯¦ç»†ä¿¡æ¯
cron:tasks                 # ä»»åŠ¡IDé›†åˆ
cron:stats:{task_id}       # ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯
cron:history:{result_id}   # æ‰§è¡Œç»“æœè¯¦æƒ…
cron:history_list          # æ‰§è¡Œå†å²æœ‰åºé›†åˆ
```

## APIä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºHTTPä»»åŠ¡

```go
// åˆ›å»ºHTTPä»»åŠ¡
req := &CreateTaskRequest{
    Name:        "å®šæœŸæ•°æ®åŒæ­¥",
    Description: "æ¯å°æ—¶åŒæ­¥ä¸€æ¬¡ç”¨æˆ·æ•°æ®",
    Cron:        "0 0 * * * *",
    Type:        TaskTypeHTTP,
    Config: HTTPConfig{
        URL:          "https://api.example.com/sync",
        Method:       "POST",
        Headers:      map[string]string{"Authorization": "Bearer token"},
        Body:         `{"sync_type": "users"}`,
        Timeout:      30 * time.Second,
        RetryCount:   3,
        RetryDelay:   5 * time.Second,
        ExpectedCode: 200,
    },
}

taskInfo, err := cronService.CreateTask(ctx, req)
```

### æ§åˆ¶ä»»åŠ¡

```go
// å¯åŠ¨ä»»åŠ¡
err := cronService.StartTask(ctx, taskID)

// æš‚åœä»»åŠ¡
err := cronService.PauseTask(ctx, taskID)

// åœæ­¢ä»»åŠ¡
err := cronService.StopTask(ctx, taskID)

// ç«‹å³æ‰§è¡Œ
err := cronService.ExecuteTaskNow(ctx, taskID)
```

### æŸ¥è¯¢ä»»åŠ¡

```go
// è·å–ä»»åŠ¡åˆ—è¡¨
req := &TaskListRequest{
    Page:     1,
    PageSize: 10,
    Status:   TaskStatusActive,
}
result, err := cronService.ListTasks(ctx, req)

// è·å–æ‰§è¡Œå†å²
historyReq := &TaskExecHistoryRequest{
    TaskID:   taskID,
    Page:     1,
    PageSize: 20,
}
history, err := cronService.GetTaskExecHistory(ctx, historyReq)
```

## è‡ªå®šä¹‰ç³»ç»Ÿä»»åŠ¡å¤„ç†å™¨

```go
type CustomHandler struct {
    logger logger.Logger
}

func (h *CustomHandler) Handle(ctx context.Context, params map[string]interface{}) (string, error) {
    // å®ç°è‡ªå®šä¹‰é€»è¾‘
    return "æ‰§è¡Œå®Œæˆ", nil
}

func (h *CustomHandler) GetName() string {
    return "custom_handler"
}

func (h *CustomHandler) GetDescription() string {
    return "è‡ªå®šä¹‰ä»»åŠ¡å¤„ç†å™¨"
}

// æ³¨å†Œå¤„ç†å™¨
RegisterSystemTaskHandler(&CustomHandler{logger: log})
```

## æ€§èƒ½ç›‘æ§

æœåŠ¡æä¾›è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡ï¼š

```go
// è·å–è°ƒåº¦å™¨çŠ¶æ€
status, err := cronService.GetSchedulerStatus(ctx)
// è¾“å‡ºï¼šè¿è¡ŒçŠ¶æ€ã€å¯åŠ¨æ—¶é—´ã€ä»»åŠ¡æ•°é‡ã€æ´»è·ƒä»»åŠ¡æ•°

// è·å–ä»»åŠ¡ç»Ÿè®¡
stats, err := repository.GetTaskStats(ctx, taskID)
// è¾“å‡ºï¼šæ‰§è¡Œæ¬¡æ•°ã€æˆåŠŸæ¬¡æ•°ã€å¤±è´¥æ¬¡æ•°ã€å¹³å‡æ‰§è¡Œæ—¶é—´
```

## æœ€ä½³å®è·µ

### 1. ä»»åŠ¡è®¾è®¡
- ä¿æŒä»»åŠ¡å¹‚ç­‰æ€§
- é¿å…é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- ä½¿ç”¨é‡è¯•æœºåˆ¶å¤„ç†ä¸´æ—¶å¤±è´¥

### 2. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®ä»»åŠ¡æ‰§è¡Œé¢‘ç‡
- é¿å…åŒæ—¶æ‰§è¡Œå¤§é‡ä»»åŠ¡
- å®šæœŸæ¸…ç†æ‰§è¡Œå†å²
- ç›‘æ§Rediså†…å­˜ä½¿ç”¨

### 3. é”™è¯¯å¤„ç†
- è®¾ç½®åˆé€‚çš„é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿ
- è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- ç›‘æ§ä»»åŠ¡å¤±è´¥ç‡
- è®¾ç½®å‘Šè­¦æœºåˆ¶

### 4. å®‰å…¨è€ƒè™‘
- HTTPä»»åŠ¡ä½¿ç”¨HTTPS
- æ•æ„Ÿä¿¡æ¯ä¸è¦è®°å½•åœ¨æ—¥å¿—ä¸­
- é™åˆ¶ä»»åŠ¡æ‰§è¡Œæƒé™
- å®šæœŸå®¡è®¡ä»»åŠ¡é…ç½®

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **ä»»åŠ¡ä¸æ‰§è¡Œ**
   - æ£€æŸ¥cronè¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ä»»åŠ¡çŠ¶æ€ä¸º`active`
   - æŸ¥çœ‹è°ƒåº¦å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ

2. **HTTPä»»åŠ¡å¤±è´¥**
   - æ£€æŸ¥URLæ˜¯å¦å¯è®¿é—®
   - éªŒè¯è¯·æ±‚å¤´å’Œè®¤è¯ä¿¡æ¯
   - ç¡®è®¤æœŸæœ›çŠ¶æ€ç è®¾ç½®

3. **Redisè¿æ¥é—®é¢˜**
   - æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥é…ç½®
   - æŸ¥çœ‹ç½‘ç»œè¿é€šæ€§

### æ—¥å¿—çº§åˆ«

- `DEBUG` - è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- `INFO` - æ­£å¸¸çš„è¿è¡Œä¿¡æ¯
- `WARN` - è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚é‡è¯•ï¼‰
- `ERROR` - é”™è¯¯ä¿¡æ¯

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„ä»»åŠ¡ç±»å‹

1. å®ç°`Task`æ¥å£
2. åˆ›å»ºå¯¹åº”çš„é…ç½®ç»“æ„
3. åœ¨`Repository`ä¸­æ·»åŠ åºåˆ—åŒ–/ååºåˆ—åŒ–é€»è¾‘
4. åœ¨`Service`ä¸­æ·»åŠ åˆ›å»ºé€»è¾‘

### æ·»åŠ æ–°çš„ç³»ç»Ÿä»»åŠ¡å¤„ç†å™¨

1. å®ç°`SystemTaskHandler`æ¥å£
2. åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶æ³¨å†Œ
3. æä¾›é…ç½®æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

## é…ç½®ç¤ºä¾‹

```yaml
# config.yaml
redis:
  host: localhost
  port: 6379
  password: ""
  db: 0
```

## ä¾èµ–é¡¹

- `github.com/robfig/cron/v3` - Cronè¡¨è¾¾å¼è§£æå’Œè°ƒåº¦
- `github.com/redis/go-redis/v9` - Rediså®¢æˆ·ç«¯
- `github.com/google/uuid` - UUIDç”Ÿæˆ
- `go.uber.org/fx` - ä¾èµ–æ³¨å…¥æ¡†æ¶ 